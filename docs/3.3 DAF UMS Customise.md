[home](https://github.com/zeditor01/zowe_db2_tools/blob/main/docs/ZPDT_Build_Path.md)

# 3.3 DAF and UMS : Customise

Installing software for z/OS typically involves 4 Steps
1. Download the Portable Software Instance (PSI) from ShopZ to a ZFS file system on z/OS
2. Deploy the PSI (unpack it into the target z/OS datasets, and adjust z/OS parameters)
3. Customize the Software (creating instances of it, configuring connections, setting up ISPF panels etc...)   <<<--- This page
4. Installation Verification Testing 


## Scope of this page

This page provides a worked example of Customizing the Portable Software Instance of Db2 Administration Foundation and Unified Management Server (DAF and UMS) from ShopZ download server to your z/OS image.

## Starting point

It makes sense to order DAF and UMS together, because they go together: DAF is the Zowe App that is the user interface sitting atop the UMS Server.

It is assumed that you have already deployed DAF and UMS.

## Product Documentation

These notes are merely an easy-to-consume worked example. You are encouraged to refer to the official product documentation for definitive product information.
* [Preparing for Installation](https://www.ibm.com/docs/en/umsfz/1.2.0?topic=server-preparation-installation)
* [Installing](https://www.ibm.com/docs/en/umsfz/1.2.0?topic=server-installing-unified-management)


## Customisation Overview
The high-level overview of steps is
1. Create a copy of the Sample JCL dataset and it's members
2. Allocate the UMS Parmlib Dataset (where the instance YAML files will reside)
3. Edit the ZWEYAML member (to specify the instance we are about to create)
4. Customize and Execute the IZPGENER job, which will generate customized jobs (based on ZWEYAML) to deploy the instance
5. Open the generated JCLLIB PDS, and submit the customised jobs in the correct sequence
6. Stop Zowe, Edit the Zowe Proclib member in include UMS in the Zowe server, Restart Zowe
7. Open the Unified Management Server app, and debug any startup errors.


Go to ISPF option 3.2 and display the DAFUMS.IZP.SIZPSAMP PDS

![cust_dafums_01](/images/cust_dafums_01.jpg)

Displaying the dataset information of the Samples dataset will cache those properties for the instance copy of it.

![cust_dafums_02](/images/cust_dafums_02.jpg)

Allocate the instance samples dataset ( DAFUMS.IZP.I1.SIZPSAMP )

![cust_dafums_03](/images/cust_dafums_03.jpg)

Accept all the properties displayed, except remove the Volume Serial so that SMS can allocate it based on SMS ACS rules.

![cust_dafums_04](/images/cust_dafums_04.jpg)

Go to ISPF option 3.3, and copy all the members of DAFUMS.IZP.SIZPSAMP

![cust_dafums_05](/images/cust_dafums_05.jpg)

... to DAFUMS.IZP.I1.SIZPSAMP

![cust_dafums_06](/images/cust_dafums_06.jpg)

Go to ISPF option 3.4 and view the 6 members of DAFUMS.IZP.I1.SIZPSAMP

![cust_dafums_07](/images/cust_dafums_07.jpg)

Edit and submit DAFUMS.IZP.I1.SIZPSAMP(IZPALOPL), which is a job to allocate the instance PARMLIB, which I am naming DAFUMS.IZP.I1.PARMLIB

![cust_dafums_08](/images/cust_dafums_08.jpg)

Edit and submit DAFUMS.IZP.I1.SIZPSAMP(IZPCPML) which copies the template ZWEYAML member to the instance PARMLIB.

![cust_dafums_09](/images/cust_dafums_09.jpg)

Edit DAFUMS.IZP.I1.SIZPSAMP(ZWEYAML) ***very carefully***

I emphasize to take care, because these YAML files are extremely sensitive to layout, indentation and case. Do it right once, and save yourself a lot of re-working effort.

![cust_dafums_10](/images/cust_dafums_10.jpg)

An excerpt for the lines that I edited in included below, with line-numbered notes to explain the logic for my edits.

* line 28. specifies the USS path for any installed experiences. We are installing the Db2 Admin Foundation, so add the path.
* Lines 34 - 36. allows you to provide a Jon card for all the deployment jobs that will be generated.
* Line 42. specifies the USS path for UMS itself.
* Line 50. specifies the path of the workspace directory, which needs 755 permissions
* Line 66. specifies that UMS will always use the SAF (eg: RACF) for authentication. (Earlier versions of UMS allowed UMS-based authentication).
* Line 80. specifies that PASSWORD authentication will be used
* Lines 86, 94, 103 are left blank because we will use RACF keyrings rather that USS keystores to hold our certificates
* Lines 109 - 125. specifies the "DBA user" for UMS, and the name of the authentication token it will use.
* Lines 129 - 182. specifies the Keyrings and certificates that will be used by UMS.
* Lines 187 - 208. specifies the roles that will be used with the IZP RACF class.
* Lines 213 - 284. specifies the network and TLS identities
* Lines 296 - 340. specifies the locations of UMS and DB2 datasets
* Lines 345 - 377. specifies the tools discovery parameters, that we will come back to later.


```
000027     experiences:                   
000028       - /usr/lpp/IBM/afx/v1r2m0/bin

000033     jobCard:                                               
000034       - //IZPCUST1 JOB (FB3),'UMSCUST',CLASS=A,MSGCLASS=H, 
000035       - //       NOTIFY=&SYSUID,REGION=0M,TIME=1440        
000036       - //*                                                

000042     runtimeDirectory: "/usr/lpp/IBM/izp/v1r2m0/bin" 

000050     workspaceDirectory: "/global/ums"

000061     security:   
...
000066       useSAFOnly: true   
...
000080         defaultAuthenticationMechanism: PASSWORD 
...
000086         # defaultDbaUserCertificateLabel:     
000094         # defaultDbaUserCertificateLocation:  
000103         # defaultDbaUserCertificateKeystoreType:    
...
000109       profileQualifier:                                               
000110       #                                                               
000111       # Encryption using ICSF PKCS#11 services.                       
000112       #                                                               
000113       pkcs11:                                                         
000114         #                                                             
000115         # The user name of dba that goes with the encrypted password. 
000116         #                                                             
000117         dbaUser: IZPDBA                                               
000118         #                                                             
000119         # The pkcs#11 token where the secret key material is stored.  
000120         #                                                             
000121         token: IZPTOK                                                 
000122         #                                                             
000123         # Path to pkcs#11 provider module.                            
000124         #                                                             
000125         library: /usr/lpp/pkcs11/lib/csnpca64.so                      
...
000129       certificate:                                                                                                 
000134         allowSelfSigned: true                                        
...                                                        
000142         truststore:                                                                                                   
000151           location: "////ZWESVUSR/ZoweKeyring"                       
000159           type: "JCERACFKS" 
...
000163         keystore:                                              
000170           location: "////ZWESVUSR/ZoweKeyring"                       
000178           type: "JCERACFKS"                                                                              
000182           alias: "zowes0w1"   
...
000187       profilePrefix:             
000188         # Super Role             
000189         super: IZP.SUPER         
000190         # Administrator Role     
000191         admin: IZP.ADMIN         
...                        
000200       surrogateUser:             
000201         # Super Role             
000202         super: IZPSRGSP          
000203         # Administrator Role     
000204         admin: IZPSRGAD          
...                   
000208       surrogateGroup: IZPSRGRP   
...
000213     server:                            
000221       tlsVersionList: TLSv1.2,TLSv1.3  
000228       authType: STANDARD_JWT           
...
000232       port:           
000233         http: 12023   
000234         agent: 3444   
000235         gremlin: 8182                                  
...
000284       allSysnames: "S0W1"     
...
000296     dataset:                                                  
000300       runtimeHlq: "DAFUMS.IZP"                                
000305       hlq: "DAFUMS.IZP.I1"                                    
000310       parmlib: "DAFUMS.IZP.I1.PARMLIB"                         
000315       jcllib: "DAFUMS.IZP.I1.JCLLIB"                           
...
000319       loadLibrary:               
000320         db2: "DSND10.SDSNLOAD"   
000326         # izp:                   
...
000331       dbaEncryption: "DAFUMS.IZP.I1.DBA.ENCRYPT"      
000335       userList: "DAFUMS.IZP.I1.USERLIST"              
000340       teamList: "DAFUMS.IZP.I1.TEAMLIST"              
...
000345     toolsDiscovery:                                              
000349       enabled: true                                              
000360       discoverySearchPaths: []                                   
000361     #                                                            
000362     # Zowe app-specific parameters                               
000363     #                                                            
000364     zowe:                                                        
000365       job:                                                       
000366         #                                                        
000367         # Suffix for Java program which will be run by UMS.  Defa
000368         #                                                        
000369         suffix: IZP                                              
000370 zowe:                                                            
000371   # These zowe items are required by the IZP setup.  Do not edit.
000372   setup:                                                         
000373     zis:                                                         
000374      parmlib:                                                    
000375        keys:                                                     
000376          IZP.ZSSP.REG: list                                      
000377   useConfigmgr: true                                       
```


My edited DAFUMS.IZP.I1.PARMLIB(ZWEYAML) file looks like this in full.

```
# ZWEYAML: Zowe parameters for IBM Unified Management Server                         
                                                                                     
# Note: not recommended to remove or comment out elements.  Deleting elements        
# can result in unpredictable behavior during upgrades.                              
# Comments added may be removed during IZPSYNCY upgrades.                            
                                                                                     
components:                                                                          
  izp:                                                                               
    #                                                                                
    # This is required by Zowe to launch IZP during Zowe startup.                    
    # It should always be true.                                                      
    #                                                                                
    enabled: true                                                                    
    #                                                                                
    # Whether or not to set -x to enable shell debugging.                            
    # Change only if instructed by IBM customer support.                             
    #                                                                                
    debugShellScripts: false                                                         
    #                                                                                
    # The runtimeDirectory values of the experiences included.                       
    # Example:                                                                       
    #   experiences:                                                                 
    #   - /usr/lpp/IBM/doe/v1r3m0/bin                                                
    #   - /usr/lpp/IBM/afx/v1r2m0/bin                                                
    #   - /usr/lpp/IBM/afn/v1r7m0/bin                                                
    #                                                                                
    experiences:                         
    - /usr/lpp/IBM/afx/v1r2m0/bin    
    #                                                                                
    # The job card that will be used for generated                                   
    # jobs when submitting IZPGENER.                                                 
    #                                                                                
    jobCard:                                                                         
      - //IZPCUST1 JOB (UMS),'UMSCUST',CLASS=A,MSGCLASS=H,                       
      - //       NOTIFY=&SYSUID,REGION=0M,TIME=1440                                  
      - //*                                                                          
    #                                                                                
    # The path where the SMP/E installer places the runtime files. This location     
    # may be read-only so modifications should be done in                            
    # {components.izp.workspaceDirectory}.                                           
    #                                                                                
    runtimeDirectory: "/usr/lpp/IBM/izp/v1r2m0/bin"                                  
    #                                                                                
    # The writable location where Unified Management Server can store files          
    # and other data important to core functionality. This should not be             
    # the same as {components.izp.runtimeDirectory}/ums/var. If you make             
    # your workspace directory inside of your runtime directory, then validation     
    # will fail and you will not be able to proceed with starting the server.        
    #                                                                                
    workspaceDirectory: "/global/ums"                                                
    #                                                                                
    # If applicable, the path of Unified Management Server v1.1                      
    # read/write directory.  This is the value of the IZP_UMS_VARDIR                 
    # variable.  It is recommended to not put the same value for                     
    # workspaceDirectory above.                                                      
    #                                                                                
    migrationDirectory:                                                              
    #                                                                                
    # Properties that will interface with your security manager.                     
    #                                                                                
    security:                                                                        
      #                                                                              
      # Whether to use SAF (system authorization facility) for all UMS access,       
      # rather than relying upon the User and Team list datasets.                    
      #                                                                              
      useSAFOnly: true                                                               
      #                                                                              
      # The following fields are used for authentication specification               
      #                                                                              
      dba:                                                                           
        #                                                                            
        # The type of authentication that the dba user will use                      
        # when connecting to services.                                               
        #                                                                            
        # The options are 'CERTIFICATE' or 'PASSWORD'.                               
        #                                                                            
        # CERTIFICATE authentication is currently supported by IMS subsystems        
        # Db2 subsystems must use PASSWORD authentication                            
        #                                                                            
        defaultAuthenticationMechanism: PASSWORD                                     
        #                                                                            
        # When using CERTIFICATE authentication, this is                             
        # the label of the dba user client certificate. This is                      
        # the label used to connect a certificate to the key ring.                   
        #                                                                            
        defaultDbaUserCertificateLabel:                                              
        #                                                                            
        # When using CERTIFICATE authentication, this is
        # the location of the dba user client certificate                  
        # in URL form.                                                     
        #                                                                  
        # example: safkeyring://ZWESVUSR/ZoweRing                          
        #                                                                  
        defaultDbaUserCertificateLocation:                                 
        #                                                                  
        # When using CERTIFICATE authentication, this is                   
        # the type of key ring that contains the dba user                  
        # client certificate.                                              
        #                                                                  
        # Example: JCERACFKS                                               
        # Example: JCECCARACFKS                                            
        #                                                                  
        defaultDbaUserCertificateKeystoreType:                             
      #                                                                    
      # Second qualifier for SAF checks to IZP resources such              
      # as function, role, and team profiles when                          
      # useSAFOnly is true.                                                
      #                                                                    
      profileQualifier:                                                    
      #                                                                    
      # Encryption using ICSF PKCS#11 services.                            
      #                                                                    
      pkcs11:                                                              
        #                                                                  
        # The user name of dba that goes with the encrypted password.      
        #                                                                  
        dbaUser: IZPDBA                                                    
        #                                                                  
        # The pkcs#11 token where the secret key material is stored.       
        #                                                                  
        token: IZPTOK                                                      
        #                                                                  
        # Path to pkcs#11 provider module.                                 
        #                                                                  
        library: /usr/lpp/pkcs11/lib/csnpca64.so                           
      #                                                                    
      # Used to secure communication over https.                           
      #                                                                    
      certificate:                                                         
        #                                                                  
        # Whether or not Unified Management can use                        
        # self-signed certificates.                                        
        #                                                                  
        allowSelfSigned: true                                              
        #                                                                  
        # Contains trust material used by Unified Management Server.       
        #                                                                  
        # If you want to specify a specific trust store, then you          
        # should remove the leading # on lines with the following          
        # text.                                                            
        #                                                                  
        truststore:                                                        
          #                                                                
          # The path or user and key ring name to a trust store.           
          #                                                                
          # Example: safkeyring:////ZWESVUSR/IZPRING                       
          # Example: file://absolute/path/to/a/truststore                  
          # Note: Keyring syntax must use four slashes (safkeyring:////)   
          # Two slashes (safkeyring://) will not be recognized.            
          #                                                                
          location: "////ZWESVUSR/ZoweKeyring"                             
          #                                                                
          # The type of trust store that is being used.                    
          #                                                                
          # Example: JCERACFKS                                             
          # Example: JKS                                                   
          # Example: PKCS12                                                
          #                                                                
          type: "JCERACFKS"                                                
        #                                                                  
        # Contains key material used by Unified Management Server.         
        #                                                                  
        keystore:                                                          
          #                                                                
          # The path or user and key ring name to a key store.             
          #                                                                
          # Example: safkeyring:////ZWESVUSR/IZPRING                       
          # Example: file://absolute/path/to/a/keystore                    
          #                                                                
          location: "////ZWESVUSR/ZoweKeyring"                             
          #                                                                
          # The type of key store that is being used.                      
          #                                                                
          # Example: JCERACFKS                                             
          # Example: JKS                                                   
          # Example: PKCS12                                                
          #                                                                
          type: "JCERACFKS"
          #                                                                
          # The name of the alias of the server certificate.               
          #                                                                
          alias: "zowes0w1"                                                
      #                                                                    
      # Prefix to generic profiles created during installation. The        
      # profiles are used to denote roles.                                 
      #                                                                    
      profilePrefix:                                                       
        # Super Role                                                       
        super: IZP.SUPER                                                   
        # Administrator Role                                               
        admin: IZP.ADMIN                                                   
      #                                                                    
      # Password-less users that will be created during installation.      
      # These users are able to read and write to the user list and        
      # team list data sets on behalf of users with passwords. The zss     
      # server will conditionally impersonate the users below.             
      #                                                                    
      # Note: At present these user names may not be changed.              
      #                                                                    
      surrogateUser:                                                       
        # Super Role                                                       
        super: IZPSRGSP                                                    
        # Administrator Role                                               
        admin: IZPSRGAD                                                    
      #                                                                    
      # The default group for above users.                                 
      #                                                                    
      surrogateGroup: IZPSRGRP                                             
    #                                                                      
    # Properties that are read by Java to configure the server             
    # when running.                                                        
    #                                                                      
    server:                                                                
      #                                                                    
      # Comma separated list of enabled tls protocols used                 
      # by Unified Management Server as a client and server.               
      #                                                                    
      # tlsVersionList: TLSv1.3                                            
      # tlsVersionList: TLSv1.2                                            
      #                                                                    
      tlsVersionList: TLSv1.2,TLSv1.3                                      
      #                                                                    
      # The desired authentication type for Unified Management Server.     
      #                                                                    
      # authType: STANDARD_JWT                                             
      # authType: MFA_JWT                                                  
      #                                                                    
      authType: STANDARD_JWT                                               
      #                                                                    
      # The ports that Unified Management Server will listen on.           
      #                                                                    
      port:                                                                
        http: 12023                                                        
        agent: 3444                                                        
        gremlin: 8182                                                      
      #                                                                    
      # If nonblank, use instead of zowe.externalDomain[0]                 
      # Useful for HA configuration with DVIPA                             
      host:                                                                
      #                                                                    
      # The log location, FILE, STDOUT (i.e. job output), or BOTH          
      log:                                                                 
        destination: BOTH                                                  
        #                                                                  
        # Option for debug logging.                                        
        # When directed by customer support, to include logging for        
        # UMS classes, remove "[]" and put logging lines each on a         
        # line by itself, indented the same as "properties:", and          
        # preceded by a hyphen.  E.g.                                      
        #                                                                  
        # - com.rocketsoft.example.level=FINE                              
        #                                                                  
        properties: []                                                     
      #                                                                    
      # The maximum number of HTTP requests per user.                      
      #                                                                    
      apiRateCapacityByUser: 600                                           
      #                                                                    
      # The memory to be allocated for Unified Management                  
      # Server in megabytes.                                               
      #                                                                    
      memorySize: 16384                                                    
      #                                                                    
      # The job code for Unified Management Server jobs. The               
      # jobPrefix associated for a team overrides this value.              
      #                                                                    
      jobPrefix: "IZP"                                                     
      failsafeTimeout: 100
      graphQLTimeout: 300                                                                 
      #                                                                                   
      # How frequently to refresh object discovery for registered                         
      # subsystems in hours.                                                              
      #                                                                                   
      # Min=1                                                                             
      # Max=24                                                                            
      #                                                                                   
      objectDiscoveryInterval: 24                                                         
      #                                                                                   
      # A space separated list of lpar names that you'd like to do                        
      # system discovery on.                                                              
      #                                                                                   
      # allSysnames: SYS1 SYS2 SYS3                                                       
      #                                                                                   
      allSysnames: "S0W1"                                                                 
      #                                                                                   
      # An array of Java Virtual Machine arguments to pass to the server.                 
      # javaArgs:                                                                         
      # - -Dcom.rocketsoft.foo=bar                                                        
      #                                                                                   
      javaArgs: []                                                                        
    #                                                                                     
    # These data sets will be used during installation and run time.                      
    # They shouldn't exist unless otherwise specified. The rest will                      
    # be created at some point during the configuration process.                          
    #                                                                                     
    dataset:                                                                              
      #                                                                                   
      # The hlq where the smp/e data sets reside.                                         
      #                                                                                   
      runtimeHlq: "DAFUMS.IZP"                                                            
      #                                                                                   
      # The high-level qualifier for miscellaneous data sets                              
      # created during runtime and installation.                                          
      #                                                                                   
      hlq: "DAFUMS.IZP.I1"                                                                
      #                                                                                   
      # The location of your PARMLIB dataset                                              
      # Use template for recommended value                                                
      #                                                                                   
      parmlib: "DAFUMS.IZP.I1.PARMLIB"                                                    
      #                                                                                   
      # The location for JCL members generated by IZPGENER                                
      # Use template for recommended value                                                
      #                                                                                   
      jcllib: "DAFUMS.IZP.I1.JCLLIB"                                                      
      #                                                                                   
      # Load libraries for various parts of Unified Management Server.                    
      #                                                                                   
      loadLibrary:                                                                        
        db2: "DSND10.SDSNLOAD"                                                            
        # The data set name where the UMS load library resides.                           
        # Optional Parameter                                                              
        # If this value is blank, the default data set (runtimeHlq.SIZPLOAD)              
        # is used. When you move the library,  you need to specify                        
        # the data set name here to override the default.                                 
        izp:                                                                              
      #                                                                                   
      # Contains encrypted password of the dba user in yaml format after                  
      # running the dba encryption shell script.                                          
      #                                                                                   
      dbaEncryption: "DAFUMS.IZP.I1.DBA.ENCRYPT"                                          
      #                                                                                   
      # Contains cache of UMS user data.                                                  
      #                                                                                   
      userList: "DAFUMS.IZP.I1.USERLIST"                                                  
      #                                                                                   
      # Contains cache of UMS team data. This data set should never be modified           
      # manually.                                                                         
      #                                                                                   
      teamList: "DAFUMS.IZP.I1.TEAMLIST"                                                  
    #                                                                                     
    # Contains the paths (uss file path, dataset name, dataset HLQ) to                    
    # find other Db2 tools product's yaml files.                                          
    #                                                                                     
    toolsDiscovery:                                                                       
      #                                                                                   
      # default is true                                                                   
      #                                                                                   
      enabled: true                                                                       
      #                                                                                   
      # An array of strings containing the possible locations of a product's yaml         
      # file. Each of these paths will begin with a 3 letter identifier followed          
      # by a colon to assist in the search for the yaml file. The identifiers are         
      # DIR (uss path) and DSN (fully qualified dataset - this includes PDS in which      
      # case the member name must be present).                                            
      # If enabled is true and discoverySearchPaths is empty then the default search      
      # path is "/usr/lpp"                                                                
      # Example: ["DIR:/usr/lpp/db2tools", "HLQ:BOB.DB2TOOLS", "DSN:ME.DSN.PDS(MEMBER)",
      #           "DSN:ME.DSN.SEQ"]                                             
      discoverySearchPaths: []                                                  
    #                                                                           
    # Zowe app-specific parameters                                              
    #                                                                           
    zowe:                                                                       
      job:                                                                      
        #                                                                       
        # Suffix for Java program which will be run by UMS.  Default is "IZP"   
        #                                                                       
        suffix: IZP                                                             
zowe:                                                                           
  # These zowe items are required by the IZP setup.  Do not edit.               
  setup:                                                                        
    zis:                                                                        
     parmlib:                                                                   
       keys:                                                                    
         IZP.ZSSP.REG: list                                                     
  useConfigmgr: true                                                            
```



Now that ZWEYAML is edited, we need to stop Zowe and generate & run the setup jobs. Go to SDSF and locate the Zowe jobs with the command ```Pre ZWE*```


![cust_dafums_11](/images/cust_dafums_11.jpg)

Enter a ```'``` in the command input to bring up the System Command extension.

Type ```p ZWESLSTC``` and press enter.

![cust_dafums_12](/images/cust_dafums_12.jpg)

Wait until only ZWESISTC is left ...

![cust_dafums_13](/images/cust_dafums_13.jpg)

and enter command ```p ZWESISTC```

![cust_dafums_14](/images/cust_dafums_14.jpg)


Now we are ready to customize and run IZPGENER, to generate the deployment jobs. You will need to set the STEPLIB, the schema concatenation and the PARMLIB

My DAFUMS.IZP.I1.SIZPSAMP(IZPGENER) looks like this:

```
//IZPGENER JOB (UMS),'UMS ALLOC',CLASS=A,MSGCLASS=H,                    
//       NOTIFY=&SYSUID,REGION=0M,TIME=1440                             
//*                                                                     
//* This job is responsible for generating other jobs required          
//* to configure Unified Management Server.                             
//*                                                                     
//* The method of validating your configuration is using                
//* JSON Schema <https://json-schema.org>. Zowe provides                
//* the ConfigMgr to assist in this. This job will invoke               
//* the ConfigMgr to validate your current configuration                
//* before generating any jobs. If there are any values                 
//* that are incorrect, you will be notified. You should                
//* fix the value and then run this job again. You can run              
//* this job as many times as you need.                                 
//*                                                                     
//* Note: Any string with braces has an associated yaml value           
//*       in one of the yaml definitions for Zowe or IZP.               
//*       You should find the value and substitute it.                  
//*                                                                     
//*       {key} -> value                                                
//*                                                                     
//*       Values with the pattern {components.izp...}                   
//*       are located in the IZP yaml.  Other values are                
//*       located in the Zowe yaml.                                     
//*                                                                     
//GENER    EXEC PGM=IKJEFT1B                                            
//ISPPROF  DD   DSN=,DISP=(NEW,DELETE),UNIT=,                           
//   DCB=(RECFM=FB,LRECL=80,BLKSIZE=3120,DSORG=PO),                     
//   SPACE=(3120,(20,5,10))                                             
//*                                                                     
//* Replace {components.izp.dataset.runtimeHlq} with the                
//* HLQ where SMP/E installed data sets are located.                    
//*                                                                     
//SYSPROC  DD   DSN=DAFUMS.IZP.SIZPREXX,DISP=SHR                        
//*                                                                     
//* Replace {zowe.setup.dataset.loadlib} with the data set              
//* that contains Zowe executables. This data set will have             
//* the suffix 'SZWELOAD'.                                              
//*                                                                     
//*                                                                     
//STEPLIB  DD   DSN=ZWE200.SZWELOAD,DISP=SHR                            
//ISPPLIB  DD   DSN=ISP.SISPPENU,DISP=SHR                               
//ISPMLIB  DD   DSN=ISP.SISPMENU,DISP=SHR                               
//ISPTLIB  DD   DSN=ISP.SISPTENU,DISP=SHR                               
//ISPSLIB  DD   DSN=ISP.SISPSENU,DISP=SHR                               
//*                                                                     
//* The order must be as follows.                                       
//*                                                                     
//* izp-schema.json                                                     
//* zowe-yaml-schema.json                                               
//* server-common.json                                                  
//*                                                                     
//* Replace {components.izp.runtimeDirectory} with where your           
//* IZP run time directory is. This is where you placed smp/e           
//* files in USS.                                                       
//*                                                                     
//* Replace {zowe.runtimeDirectory} with where your Zowe run time       
//* directory is.                                                       
//*                                                                     
//MYSCHEMA DD   *,DLM=$$                                                
FILE /usr/lpp/IBM/izp/v1r2m0/bin/ums/izp-schema.json                    
FILE /usr/lpp/zowe/schemas/zowe-yaml-schema.json                        
FILE /usr/lpp/zowe/schemas/server-common.json                           
$$                                                                      
//*                                                                     
//* The order must be as follows.                                       
//*                                                                     
//* IZP PARMLIB (recommended) or yaml file (Zowe 2.5 and below)         
//* Zowe yaml file                                                      
//*                                                                     
//* Replace {components.izp.dataset.parmlib} with the location of the   
//* PARMLIB dataset as specified in the IZP override yaml ZWEYAML.      
//*                                                                     
//MYCONFIG DD   *,DLM=$$                                                
PARMLIB DAFUMS.IZP.I1.PARMLIB                                           
FILE /apps/zowe/v20/zowe.yaml                                           
$$                                                                      
//CMGROUT  DD   SYSOUT=*                                                
//SYSPRINT DD   SYSOUT=*                                                
//SYSTSPRT DD   SYSOUT=*                                                
//*                                                                     
//* Change 'generate' to 'nogenerate' if you only                       
//* want to validate your configuration. The default                    
//* option, 'generate', will validate and then generate                 
//* jobs based on your configuration.                                   
//*                                                                     
//*   - generate
//*   - nogenerate                                    
//*                                                   
//* Change 'noverbose' to 'verbose' below for         
//* advanced logging. This is not needed unless       
//* there is an error.                                
//*                                                   
//*   - verbose                                       
//*   - noverbose                                     
//*                                                   
//SYSTSIN  DD   *                                     
ISPSTART CMD(%IZPGEN00 -                              
generate -                                            
noverbose -                                           
)                                                     
```

The output of IZPGENER should include the creation of two new datasets: DAFUMS.IZP.I1.ENVIRON and DAFUMS.IZP.I1.JCLLIB (where the jobs are created).

![cust_dafums_15](/images/cust_dafums_15.jpg)

Open up DAFUMS.IZP.I1.JCLLIB


![cust_dafums_16](/images/cust_dafums_16.jpg)

We don't need to run all the jobs.

In this worked example, the sequence of jobs that I chose to run were as follows.

```
IZPA1.... N/A - allocates TEAMLIST, which is no longer used for access control because UMS now requires useSAFOnly: true
IZPA1V... verification job

IZPA2.... N/A - allocates USERLIST, which is no longer used for access control because UMS now requires useSAFOnly: true    
IZPA2V... verification job
  
IZPA3.... Required - allocates IZP.CUST.DBA.ENCRYPT, which is used to store the encryption token for the DBA id.  
IZPA3V... verification job
 
IZPB0R... N/A - Create a new group for surrogate users. This is not required for useSAFOnly: true   
IZPB0VR.. verification job
   
IZPB1R... Required - Create IZP class and add to the CDT.  
IZPB1VR.. verification job
    
IZPB2R... Required - Add security role profiles to the IZP class.   
IZPB2VR.. verification job
   
IZPB3R... N/A - Create generic profiles to secure userList and teamList data sets. This is not required if useSAFOnly=true.  
IZPB3VR.. verification job
   
IZPB4R... Required - Create RACF IZP resource profiles to define the UMS users and their roles.  
IZPB4VR.. verification job
   
IZPC1R... N/A - Add surrogate users to impersonate when accessing the userList and teamList data sets during runtime. This is not required if useSAFOnly=true.  
IZPC1VR.. verification job
   
IZPC2R... N/A - Grant surrogate user access to the userList and teamList profiles. This is not required if useSAFOnly=true.  
IZPC2VR.. verification job
   
IZPD1R... Required - Define CRYPTOZ resource profiles for the PKCS #11 token for UMS.   
IZPD1VR.. verification job
   
IZPD2R... Required - Grant system programmer and started task access to PKCS #11 resources. 
IZPD2VR.. verification job
   
IZPD3R... Required - Create the PKCS #11 token for UMS.   
IZPD3VR.. verification job
   
IZPD4R... Required - Add a new user to serve as the DBA user ID.  
IZPD4VR.. verification job
   
IZPD5R... Required - Connect the DBA user ID to the IZUUSER group for z/OSMF.  
IZPD5VR.. verification job
   
IZPD6R... Required - Grant the DBA user ID access to applications. If useSAFOnly=true, permits are not required for the surrogate users.   
IZPD6VR.. verification job
   
IZPD7R... Required - Creates function profiles in IZP class that are used when useSafOnly is enabled, which allow users to refresh the security cache.   
IZPD7VR.. verification job
   
IZPSTEPL. Required - concatenate datasets in PROCLIB member

IZPUSRMD. N/A - If useSafOnly is set to true or you are migrating from UMS 1.1, do not submit the IZPUSRMD JCL.

izp-encrypt-dba.sh ... Required - 

IZPIPLUG. Required - Install Zowe plugins using the zwe command.

IZPEXPIN. Required - LAUNCH THE IZP EXPERIENCE INTEGRATION SCRIPT
```

Most of the jobs are written in pairs. One job to perform the step. A verification job (suffix V) to confirm the outcome

* IZPA3 - Allocate DAFUMS.IZP.I1.DBA.ENCRYPT

![cust_dafums_17](/images/cust_dafums_17.jpg)

* IZPA3V - verifies it

![cust_dafums_18](/images/cust_dafums_18.jpg)

The output of IZPA3V is shown below :

![cust_dafums_19](/images/cust_dafums_19.jpg)

And you can verify it manually by checking the existence of DAFUMS.IZP.I1.DBA.ENCRYPT

![cust_dafums_20](/images/cust_dafums_20.jpg)



* IZPB1R - Create IZP class and add to the CDT
* IZPB1RV - verifies it

![cust_dafums_21](/images/cust_dafums_21.jpg)

Before running IZPB1R it's a good idea to check whether the RACF IZP class exists already, using the ```RLIST CDT IZP``` tso command

![cust_dafums_22](/images/cust_dafums_22.jpg)

The output of IZPB1R throws up some warnings

![cust_dafums_23](/images/cust_dafums_23.jpg)

But, the verification jobs shows that everything is defined OK

![cust_dafums_24](/images/cust_dafums_24.jpg)


* IZPB2R - Add security role profiles to the IZP class.  (IZP.SUPER* and IZP.ADMIN*)

![cust_dafums_25](/images/cust_dafums_25.jpg)

* IZPB2RV - verifies it

![cust_dafums_26](/images/cust_dafums_26.jpg)

* IZPB4R - Create RACF IZP resource profiles to define the UMS users and their roles.  

![cust_dafums_27](/images/cust_dafums_27.jpg)

* IZPB4RV - verifies it

![cust_dafums_28](/images/cust_dafums_28.jpg)





* IZPD1R - Define CRYPTOZ resource profiles for the PKCS #11 token for UMS.

![cust_dafums_29](/images/cust_dafums_29.jpg)

* IZPD1RV - verifies it

![cust_dafums_30](/images/cust_dafums_30.jpg)

* IZPD2R - Grant system programmer and started task access to PKCS #11 resources.

![cust_dafums_31](/images/cust_dafums_31.jpg)

* IZPD2RV - verifies it

![cust_dafums_32](/images/cust_dafums_32.jpg)

* IZPD3R - Create the PKCS #11 token for UMS.

![cust_dafums_33](/images/cust_dafums_33.jpg)

* IZPD3RV - verifies it

![cust_dafums_34](/images/cust_dafums_34.jpg)



* IZPD4R - Add a new user to serve as the DBA user ID.  (IZPDBA)

![cust_dafums_35](/images/cust_dafums_35.jpg)

* IZPD4RV - verifies it

![cust_dafums_36](/images/cust_dafums_36.jpg)

Actually, we subsequently find that the instruction to make the password non-expiry did not work, but that comes later.

* IZPD5R - Connect IZPDBA to the IZUUSER group for z/OSMF

![cust_dafums_37](/images/cust_dafums_37.jpg)

* IZPD5RV - verifies it

![cust_dafums_38](/images/cust_dafums_38.jpg)

* IZPD6R -  Grant the DBA user ID access to applications.

![cust_dafums_39](/images/cust_dafums_39.jpg)

* IZPD6RV - verifies it. Actually, it reveals that the RACF class is not defined, which we will accept for now.

![cust_dafums_40](/images/cust_dafums_40.jpg)

* IZPD7R -  Creates function profiles in IZP class that are used when useSafOnly is enabled, which allow users to refresh the security cache.

![cust_dafums_41](/images/cust_dafums_41.jpg)

* IZPD7RV - verifies it

![cust_dafums_42](/images/cust_dafums_42.jpg)


* IZPSTEPL - executes a USS script called izp-concatenate-proclib.sh. The job checks all new services indentified in ZWELYAML, and installs them. SDSF job output below


![cust_dafums_43](/images/cust_dafums_43.jpg)



* Encrypt DBA credentials.

The script encrypts the DBA username and password, and stored them in the Encrypted Credentials Data Set: {components.izp.dataset.dbaEncryption} = DAFUMS.IZP.I1.DBA.ENCRYPT

This step is another USS script, but it must be executed from within a USS shell in order that the submitted may respond to a prompt to enter the password for the IZPDBA userid. The script invocation is captured below:


![cust_dafums_44](/images/cust_dafums_44.jpg)


And if we browse DAFUMS.IZP.I1.DBA.ENCRYPT we see what looks like and encrypted object


![cust_dafums_45](/images/cust_dafums_45.jpg)

* IZPIPLUG - Install Zowe plugins using the zwe command

![cust_dafums_46](/images/cust_dafums_46.jpg)

And the SDSF output shows the plugins being discovered and installed

![cust_dafums_47](/images/cust_dafums_47.jpg)

* IZPEXPIN - Install Zowe experiences

![cust_dafums_48](/images/cust_dafums_48.jpg)

and the SDSF output shows success

![cust_dafums_49](/images/cust_dafums_49.jpg)


So, now we are ready to edit the Zowe started task JCL in USER.Z31C.PROCLIB(SWESLSTC)

![cust_dafums_50](/images/cust_dafums_50.jpg)

The previous image is the orginal PROCLIB member, and the following image is after the changes.

![cust_dafums_51](/images/cust_dafums_51.jpg)

We are now ready to restart Zowe (including UMS and the DAF experience). Go to SDSF System Command Extension and start ZWESISTC

![cust_dafums_52](/images/cust_dafums_52.jpg)

... followed by ZWESLSTC

![cust_dafums_53](/images/cust_dafums_53.jpg)

If you're running this on a ZPDT, the cooling fan will start spinning faster and the activity on the cores of your intel chip will ramp up. Be patient. Maybe 30 minutes. Maybe less if you have a lot of cores and threads. Zowe and USS are fast when they have loaded, but they do take a while to get there on ZPDT hardware.

![cust_dafums_54](/images/cust_dafums_54.jpg)

Lets take a moment to check the Zowe RACF Keyring and Certificate. This was already setup when Zowe was pre-installed. UMS does not need any additional certificates. It runs as part of Zowe.

![cust_dafums_55](/images/cust_dafums_55.jpg)

The CPU activity is still high, as seen by the Linux monitor and SDSF.

![cust_dafums_56](/images/cust_dafums_56.jpg)

When it's finally up, you can logon to Zowe. The URL will be https://s0w1.dal-ebis.ihost.com:7554/zlux/ui/v1/ZLUX/plugins/org.zowe.zlux.bootstrap/web/

![cust_dafums_57](/images/cust_dafums_57.jpg)

There is normally a bit of debugging to be done. In this case we get a very ambiguous error message.

![cust_dafums_58](/images/cust_dafums_58.jpg)

The first place to investigate the detailed error messages is the SDSF output for task ZWESLSTC. In this case the last few lines provide the smoking gun. There was a validation error on DAFUMS.IZP.I1.PARMLIB(IZPDB2PM)

Ooops - my bad. I forgot that when I install an experience, there may be some configuration to do. In the case of Db2 Administration Foundation (DAF) it creates a couple of paramters members in DAFUMS.IZP.I1.PARMLIB

I need to tell Db2 Administration whether to use the Db2 Administration load libraries that are shipped with DAF ( HLQ: DAFUMS.AFX.** ) or the more-capable load libraries that are shipped with Db2 Administration Tool ( HLQ: ADBD10.** )

I make the edits below.

![cust_dafums_60](/images/cust_dafums_60.jpg)

Then I stop ZWESLSTC...

![cust_dafums_61](/images/cust_dafums_61.jpg)

and ZWESISTC

![cust_dafums_62](/images/cust_dafums_62.jpg)

and restart ZWE, and try again.

![cust_dafums_63](/images/cust_dafums_63.jpg)

This time, Zowe comes up clean;y, and I can open the Unified Management Server application.

![cust_dafums_64](/images/cust_dafums_64.jpg)

However, Opening UMS reveals that the password of the DB@ AI ( IZPDBA ) has expired.

![cust_dafums_65](/images/cust_dafums_65.jpg)


Drat. I don't want to have to regenerate the Encrypted Credentials Dataset DAFUMS.IZP.I1.DBA.ENCRYPT , so I change the password in RACF to something else, make it non-expiry, and then change it back to IZPPASS

I then shut down the UMS app, and relaunch it. It comes up clean, and discovers my DB2 z/OS V13 subsystem.

![cust_dafums_66](/images/cust_dafums_66.jpg)

That's the end of customizing DAF and UMS. The next step is Installation Verification Testing, which is covered in the next topic.






[home](https://github.com/zeditor01/zowe_db2_tools/blob/main/docs/ZPDT_Build_Path.md)
