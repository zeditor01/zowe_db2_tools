[home](https://github.com/zeditor01/zowe_db2_tools/blob/main/docs/ZPDT_Build_Path.md)

# QWT User Setup and Installation Verification

The previous pages have covered (a) Download of QWT PSI (b) Deployment of QWT PSI and (c) Customisation of QWT to run as a Server.

The Next step is to Start the QWT Server, and set it up for Users.


## Start the QWT Started Task

Go to SDSF and issue the command to start the QWT started task. ( s DSN5STRT )

![qwtstart](/images/qwtstart.jpg)

Go to SDSF DA and check that it is running

![qwtstart2](/images/qwtstart2.jpg)

View the SDSF output and observe the messages

![qwtstart3](/images/qwtstart3.jpg)

After a while, you will see the messages that the TMS1 server is ready to run a smarter planet. That means that the Libery Server is up an running. It is followed by the startup messages for Tuning Services.

![qwtstart4](/images/qwtstart4.jpg)

When you see the  TuningServce Initialization Successful message, you know that Liberty and QWT are up and running.
![qwtstart5](/images/qwtstart5.jpg)



## User Setup with the Swagger APIs

Open a browser. (prefer Firefox) and point it at ```https://s0w1.dal-ebis.ihost.com:15001/tuningservice/v1/swagger-ui/index.html```

Check that your browser opens the page with a secure connection. If the connection is marked insecure ( a red https:// in the URL bar ) then it is probably because you haven't previously imported the CA Certificate into your trusted root certificates store. In this case you should export the CA Certificate (Label BaseCA), save it to your PC, and import it into your trusted root certificates store.

![ivp_qwt_01](/images/ivp_qwt_01.jpg)

Note that QWT does not have an HTML home page. It provides an HTML page to review and invoke the various REST APIs that it serves. We will use these REST APIs to complete the user setup.

Tools such as Zowe and VSCODE will connect to QWT with regular authentication methods ( password, passticket etc... ) and QWT will generate a token that will persist for the durations of the connected session. In order to complete user setup, we need to use the same approach to using the APIs for a session. Click on the "Post" method to Generate Token. The Swagger page will describe the API, and offer you a "Try it Out" button.

![ivp_qwt_02](/images/ivp_qwt_02.jpg)

Push the "Try it Out" button, and enter the JSON input parameters ( userid TMSUSER, password TMSPASS ) and press "Execute". 

When it completes, scroll down to the Responses section. Hopefully it is a return code 200 (success), and a JSON body with the token. Copy the generated token into the clipboard.

![ivp_qwt_03](/images/ivp_qwt_03.jpg)

Now click on the Green Padlock (top tight), type in the word "Bearer" followed by one ( and only one ! ) space. Then paste the token into the rest of the field, and press "Authorize"

![ivp_qwt_04](/images/ivp_qwt_04.jpg)

The box will say "Authorized". Click the "Close" button to continue your authorized session with the QWT Server.

![ivp_qwt_05](/images/ivp_qwt_05.jpg)

We now have a closed green padlock, representing an authorized session. We can execute any of the APIs Below.

In order to complete user setup we will need to call APIs to
1. check the QWT license
2. set the Repository connection
3. Create a tuning profile
4. Create a set of explain tables

![ivp_qwt_06](/images/ivp_qwt_06.jpg)

Lets start with the QWT License (which is needed to unlock all the billable tuning services, in addition to the no charge services)

Click on the API to GET the license information. This API requires no parameters. So, press "Try it Out" and then "Execute.

If the license has not been installed, the API call will say that a license was not found.

![ivp_qwt_07](/images/ivp_qwt_07.jpg)

So, open an ssh shell to USS, and navigate to /usr/lpp/IBM/qwtz which is the path where the ZFS containing the license was mounted during deployment of the QWT PSI.

Execute an ```ls -al``` command to check that the license.jar file is there.

![ivp_qwt_08](/images/ivp_qwt_08.jpg)

Now switch to /global/liberty/servers/TMS1

create a directory called license

```
mkdir license
chmod 777 license
```
switch to /global/liberty/servers/TMS1/license

and copy the license file over
```
cp /usr/lpp/IBM/qwtz/license.jar .
```

![ivp_qwt_09](/images/ivp_qwt_09.jpg)

Execute the license API again, and verify that the license is found.

![ivp_qwt_10](/images/ivp_qwt_10.jpg)

Now, lets set the repository connection, by POSTING the set_repo API. This is where we tell the QWT Server where it's repository database is located.

After pushing "Try it Out" you will need to edit a set of input parameters in a JSON structure

```
{
  "credential": {
    "password": "TMSPASS",
    "user": "TMSUSER"
  },
  "host": "192.168.1.171",
  "location": "DALLASD",
  "port": "5045"
}
```

Press Execute, and you should see that the Repository Database Connection has been set successfully.

![ivp_qwt_11](/images/ivp_qwt_11.jpg)

Now we must create a tuning profile. This is essentially a definition of the Db2 subsystem for which we wish to tune SQL (which could be different from the Repository Database), and we provide connection credentials and a package path.

After pushing "Try it Out" you will need to edit a set of input parameters in a JSON structure

```
{
"collection_cred":{
  "user": "TMSUSER",
  "password": "TMSPASS"
},
"host": "192.168.1.171",
"location": "DALLASD",
"port": "5045",
"sslConnection": "false",
"additionalProperties": {
"currentPackagePath": "NULLID, IBMTMS"
},
"name":"nealep01"
}
```

Press Execute, and you should see that the Repository Database Connection has been set successfully.


![ivp_qwt_12](/images/ivp_qwt_12.jpg)

Check all existing tuning profiles with the Connections API.


![ivp_qwt_14](/images/ivp_qwt_14.jpg)

Get the owner and user for tuning profiles

![ivp_qwt_15](/images/ivp_qwt_15.jpg)

A Set of EXPLAIN tables must be created. EXPLAIN tables are used for the DB2 Optimizer to store the access path information it uses for SQL statements. These are a critical part of SQL performance tuning. We need to call the explaintb API with a set of input parameters to tell it how and where to create the explain tables.

Use the following JSON document as input

```
{
  "action": "CREATE",
  "auth_id": "IBMTMS",
  "bp16kblob": "BP16K0",
  "bp32kblob": "BP32K",
  "bp4kblob": "BP0",
  "bp8kblob": "BP8K0",
  "connection": "nealep01",
  "database_name": "EXPDB",
  "ixbufferpool": "BP0",
  "managealias": "NO",
  "mode": "RUN",
  "schema_alias": "IBMTMS_Alias",
  "schema_name": "IBMTMS",
  "storagegroup": "SYSDEFLT",
  "storagegroup_idx": "SYSDEFLT",
  "tableset": "ALL",
  "ts16kbufferpool": "BP16K0",
  "ts32kbufferpool": "BP32K",
  "ts4kbufferpool": "BP0",
  "ts8kbufferpool": "BP8K0"
}

```

![ivp_qwt_16](/images/ivp_qwt_16.jpg)

The Explain Tables API might fail if the Db2 subsystem has not been setup correctly. Specifically, it failed for me because the DB2-Supplied Stored Procedures for the ADCD distribution had not been bound. SQLCODE -805 is one of the most common SQL error codes you will ever encounter. It means that the package for a program has not been bound and the package is not found.

![ivp_qwt_17](/images/ivp_qwt_17.jpg)

Fortunately, The Db2 subsystem in the ADCD distribution has been well-customised, and the job to setup the Db2-supplied procedures is ready to submit.

I went to DSND10.NEW.SDSNSAMP(DSNTIJRT) and submitted the job. Checked it completed with Return Code 0.

![ivp_qwt_18](/images/ivp_qwt_18.jpg)

Then I came back to the Explain Table API, and it worked perfectly.


![ivp_qwt_20](/images/ivp_qwt_20.jpg)


So, the QWT Liberty Server is up and running, and the User Setup is complete. We need to test it with the first of the 2 options for using QWT: Db2 for z/OS Developer Extension for VSCODE.

Using either Mac OSX or Windows on your PC, make sure the VSCODE is installed.

Then, click on the extensions icon and search for db2. You are looking for Db2 for z/OS Developer Extension

![ivp_qwt_21](/images/ivp_qwt_21.jpg)

Press Install to install it

Open the Db2 for z/OS Developer Extension and expand "Db2 for z/OS Connections".

Click "Add Connection"

![ivp_qwt_22](/images/ivp_qwt_22.jpg)

Enter the connection information for DBDG, and press Finish.

![ivp_qwt_23](/images/ivp_qwt_23.jpg)

You may not connect to Db2 successfully first time around. 

When this happens, read the error message. 
* It tells me that the Db2 SQL Service in unavailable ( but this should be part of the Extension )
* It tells me to check the Db2 Developer Extension log for more information. (but it doesn't tell me how to do that).

![ivp_qwt_24](/images/ivp_qwt_24.jpg)

Open the VSCODE Command Palette ( CTRL+SHIFT+P ) and enter "Developer: Open Extension Logs Folder"

![ivp_qwt_25](/images/ivp_qwt_25.jpg)

It should show you the logs folder. Open that.

![ivp_qwt_26](/images/ivp_qwt_26.jpg)

Now look at the log file inside the logs folder. Unfortunately it is zero bytes long, and no help whatsoever.


![ivp_qwt_27](/images/ivp_qwt_27.jpg)

Some further research on the internet reveals that the SQL Service of the Db2 for z/OS Developer Extension depends on setting a java path.

Open VSCODE settings, and search for setting ```db2forzosdeveloperextension.java.home```


![ivp_qwt_28](/images/ivp_qwt_28.jpg)

![ivp_qwt_29](/images/ivp_qwt_29.jpg)
![cust_qwt_27](/images/cust_qwt_27.jpg)

![cust_qwt_28](/images/cust_qwt_28.jpg)

![cust_qwt_29](/images/cust_qwt_29.jpg)


[home](https://github.com/zeditor01/zowe_db2_tools/blob/main/docs/ZPDT_Build_Path.md)
