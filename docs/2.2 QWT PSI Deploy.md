[home](https://github.com/zeditor01/zowe_db2_tools/blob/main/docs/ZPDT_Build_Path.md)

# Query Workload Tuner : Deploy Portable Software Instance

Installing software for z/OS typically involves 4 Steps
1. Download the Portable Software Instance (PSI) from ShopZ to a ZFS file system on z/OS
2. Deploy the PSI (unpack it into the target z/OS datasets, and adjust z/OS parameters)  <<<--- This page
3. Customize the Software (creating instances of it, configuring connections, setting up ISPF panels etc...)
4. Installation Verification Testing


## Scope of this page

This page provides a worked example of deploying the Portable Software Instance (PSI) of Query Workload Tuner (QWT).

## Starting point

It is assumed that you have already ordered QWT from ShopZ, and downloaded the PSI.

Open the z/OSMF Software Management Application - Deployments page. From "Actions" Select New. 

![deploy_qwt_01](/images/deploy_qwt_01.jpg)

You will see a checklist in the next screen. Click the first step to Specify the properties of this deployment.

![deploy_qwt_02](/images/deploy_qwt_02.jpg)

Give this deployment a name (QWT) and optionally choose a category (Neale)

![deploy_qwt_03](/images/deploy_qwt_03.jpg)

From the checklist, choose "Select the software to deploy".

![deploy_qwt_04](/images/deploy_qwt_04.jpg)

Choose the QWT PSI that we previously downloaded.

![deploy_qwt_05](/images/deploy_qwt_05.jpg)

From the checklist, choose "Select the objective of this deployment".

![deploy_qwt_06](/images/deploy_qwt_06.jpg)

We want to create a new SMP/E CSI zone, residing on system S0W1. We are not deploying z/OS.

An SMP/E CSI dataset (Consolidated Software Inventory dataset) is a specialized VSAM key-sequenced data set used by IBM's System Modification Program Extended (SMP/E) to record and manage information about installed software products, system modifications (SYSMODs), and all related maintenance activity on a z/OS system.

![deploy_qwt_07](/images/deploy_qwt_07.jpg)

From the checklist, choose "Check for missing SYSMODS".

![deploy_qwt_08](/images/deploy_qwt_08.jpg)

Uncheck both reports to generate. These reports may be useful for adding software maintenance into an existing CSI. However, we are deploying a new portable software image into it's own CSI, so the ShopZ process should have provided the complete and correct list of SYSMODs.

![deploy_qwt_09](/images/deploy_qwt_09.jpg)

From the checklist, choose "Configure this deployment".

![deploy_qwt_10](/images/deploy_qwt_10.jpg)

There are multiple steps to configure the deployment. These steps allow us to control where deployment is placed within our z/OS system. review the welcome page to get familiar with the steps.

![deploy_qwt_11](/images/deploy_qwt_11.jpg)

Configure DLIBs : Yes we do want to copy the distribution zones for the software.

SMP/E maintains the concept of 3 zones.
* The Global Zone is a master index for the CSI and contains definitions for all other target and distribution zones.
* The Target Zone holds entries describing the contents and structure of target libraries, which contain the executable components and program products used by z/OS.
* The Distribution Zone contains entries for the distribution libraries, which store the master copy of all system elements and products. This zone is used for copying the installed product libraries to other z/OS systems.


![deploy_qwt_12](/images/deploy_qwt_12.jpg)

Configure Model : We are happy to accept the SMP/E Model supplied with the PSI. The following screens will provide us with plenty of scope to fine tune how it is deployed. 

![deploy_qwt_13](/images/deploy_qwt_13.jpg)


Configure SMP/E Zones : You many have naming standards for your SMP/E zones. I don't, so I accept the default target and distribution zone names.

![deploy_qwt_14](/images/deploy_qwt_14.jpg)

Configure Datasets : yes we are going to want to control the names and placements of datasets to be installed. Select All datasets, and choose "Modify" from the Actions pulldown.

![deploy_qwt_15](/images/deploy_qwt_15.jpg)

By default every dataset will have a meaningless HLQ. CB.ST313139 is derived from the ShopZ order number. We will change it to QWT universally, so that we can find all the datasets associated with QWT easily. 

We also choose to let Systems Managed Storage (SMS) choose where the datasets are deployed. The SMS configuration in this z/OS system contains pre-defined rules ( ACS rules ) that determine everything about where and how datasets are stored.

![deploy_qwt_16](/images/deploy_qwt_16.jpg)

Configure "Catalogs". Your system may have multiple ICF catalogs. This is a small ZPDT system. We will let everything be cataloged in the master catalog.

![deploy_qwt_17](/images/deploy_qwt_17.jpg)

From the checklist, choose "Volumes and Storage Classes". Nothing to do here because SMS is taking care of this.

![deploy_qwt_18](/images/deploy_qwt_18.jpg)

Configure Mountpoints.

Many z/OS products are shipped with one or more hierarchical files systems ( ZFS ) to store their contents. QWT ships three separate ZFS file systems.

We need to choose the ZFS paths that these filesystems are to be mounted on. Select All, and from the actions pulldown choose modify.


![deploy_qwt_19](/images/deploy_qwt_19.jpg)

We will simply remove the leading part of the path ( /applroot/CB/ST313139 ) so that the filesystems are mounted in their "standard" locations.


![deploy_qwt_20](/images/deploy_qwt_20.jpg)

From the main checklist, select "Define job settings".

![deploy_qwt_21](/images/deploy_qwt_21.jpg)

Review the job settings. Note the JCL dataset name. The JCL deployment jobs will be stored here.

![deploy_qwt_22](/images/deploy_qwt_22.jpg)

From the main checklist, select "Submit deployment jobs".

![deploy_qwt_23](/images/deploy_qwt_23.jpg)

We are presented with 5 jobs that required to deploy the PSI. We need to review and execute each in turn.


![deploy_qwt_24](/images/deploy_qwt_24.jpg)

Job #1 (IZUD01RA) is optional. It allows us to setup RACF dataset protections. The job would need to be edited to assign the correct groups to assign to the profiles and the correct IDs to have permissions. We can review the job either by clicking on the Job in the z/OSMF window, or by opening the job in the JCL dataset (IBMUSER.DM.D250820.T173424.CNTL). Open it in the ISPF editor for best text markup and highlighting.

![deploy_qwt_25](/images/deploy_qwt_25.jpg)

Being a ZPDT demo system, the RACF protection of datasets is not important. Hence, from the z/OSMF workflow I select "Override Complete" from  he Actions pulldown.

![deploy_qwt_26](/images/deploy_qwt_26.jpg)

With Job #1 marked as "override complete", I select Job #2 (Unzip datasets), and "Submit" from the Actions pulldown.

![deploy_qwt_27](/images/deploy_qwt_27.jpg)

I see it running...

![deploy_qwt_28](/images/deploy_qwt_28.jpg)

This job failed unexpectedly. I decided to leave this job failure in the worked example as an illustration of what to do when the push-button workflows fail.


![deploy_qwt_29](/images/deploy_qwt_29.jpg)

First thing I do is to review the job, to see what it is doing in detail. I open IBMUSER.DM.D250820.T173424.CNTL(IZUX02UZ) and see that it is defining a VSAM cluster for a ZFS, creating a directory (/tmp/izud-IBMUSER-T2325892) and mounting the ZFS there, so that it can run the Unzip job.

![deploy_qwt_30](/images/deploy_qwt_30.jpg)

Next thing I do is go to SDSF to see the error messages, so that I can diagnose and resolve the problem. SDSF is available via m.5 of the main ISPF menu on my system. The Job Name was IUZOSMF and the Job Number was JOB00118. I place a Question Mark nect to the job in SDSF.

![sdsferr01](/images/sdsferr01.jpg)

I'm not sure which part of the output will help yet, so I select all elements of the SDSF output.

![sdsferr02](/images/sdsferr02.jpg)

The first part (JESMSGLG) shows that 4 steps (DELCATDS, PREPARE, DEFZFS, MOUNT) completed with return code 0, but that the fifth step (GIMUNZIP) did not execute because it was Flushed.

![sdsferr03](/images/sdsferr03.jpg)





The third part (JESYSMSG) shows the execution details of each step. It shows that the GIMUNZIP step did not execute because of a JCL error: the dataset referenced by the DD card for SMPWKDIR was not found. That's odd because the MOUNT step was supposed to mount it, and the MOUNT step completed with return code 0.

![sdsferr04](/images/sdsferr04.jpg)

This is an example of when Return Code 0 can be misleading. Looking back at the JCL, the MOUNT step executes the BXPBATCH program, which is a batch program that enables shell scripts to execute in USS. The return code zero means that the shell script was executed, but it doesn't imply anything about whether the commands within the shell script were successful.

When something goes wrong, usually we hope for a clear error message that pinpoints the cause of the problem so that we can fix it. In this case, all we got was a smoking gun (the dataset was not found) and we had to guess what may have caused that to occur. 

The next step is problem determination is usually to ask "So what changed?". The last change had been to enable the bash shell within USS, rather than using the default bourne shell. So the first command (SH) conflicted with that. So I needed to change the .profile setting for my user. 

From TSO Option 2, I request to edit the .profile for my userid.

![sdsferr05](/images/sdsferr05.jpg)

And I edit the new commands in the .profile, by placing a condition that only invokes the bash shell for ssh connections. Other connections such as BPXBATCH will continue to use the bourne shell.

![sdsferr06](/images/sdsferr06.jpg)

Now it is possible to re-submit the Unzip Job. Once the Unzip job runs, you can see all the z/OS datasets that have been unzipped.





![deploy_qwt_31](/images/deploy_qwt_31.jpg)

And we get a nice green "Complete" tick by Job #2.

Now we run Job #3, to install the ZFS datasets.



![deploy_qwt_32](/images/deploy_qwt_32.jpg)

And if we review the z/OS datasets again, we see that the QWT.OMVS.** datasets have been installed.



![deploy_qwt_33](/images/deploy_qwt_33.jpg)

Now we can submit Job #4, which renames the datasets.



![deploy_qwt_34](/images/deploy_qwt_34.jpg)

And we can see the datasets have lost their trailing .#



![deploy_qwt_35](/images/deploy_qwt_35.jpg)

Now we can run Job #5 to update the SMPE CSI datasets



![deploy_qwt_36](/images/deploy_qwt_36.jpg)

And we have 5 green ticks !

![deploy_qwt_37](/images/deploy_qwt_37.jpg)


Close the "Submit Deployment Jobs" window, and see that we now need to Perform Workflows.

Workflows are a series of steps that are needed to integrated the installed software with the z/OS environment. They can include things such as
* permanently mounting ZFS filesystems at desired mountpounts (which needs PARMLIB members to be updated)
* Defining RACF profiles
* Updating SMPE CSIs with new DDDEFs (DD card definitions)

Click on "Perform Workflows"

![deploy_qwt_38](/images/deploy_qwt_38.jpg)

Select the first workflow (YOURORDER) and chose "Open" from the Actions drop down menu.

![deploy_qwt_39](/images/deploy_qwt_39.jpg)

If you are new to SMPE PSI installations I encourage you to click through each of the workflow steps and read the notes.

In this case, the YOURORDER workflow steps are standard generalised notes, with no actions to perform. Hence I select all steps, and choose "Override Complete" from the Actions pulldown menu.


![deploy_qwt_40](/images/deploy_qwt_40.jpg)

All steps in this flow are now registered as override complete. Push "Return to Workflows".

![deploy_qwt_41](/images/deploy_qwt_41.jpg)

Select the second (POSTDEPLOY) workflow. This contains important actions that must be done. Select "Open" from the Actions pulldown menu.

![deploy_qwt_42](/images/deploy_qwt_42.jpg)

Most PSI installs will read variables from a property file. If you are updating a previous installation, you may want to re-use a property file from a previous installation. This is a brand new install, so we will accept the property file that was shipped with the PSI software package. Select workflow item 1.1, and choose "Perform" from the Actions dropdown menu.

![deploy_qwt_43](/images/deploy_qwt_43.jpg)

Annser "NO" to the question about re-using a previously saved property file, and press "Next"

![deploy_qwt_44](/images/deploy_qwt_44.jpg)

The workflow will skip step 1.2 (which would have fetched the previously saved properties file) and  presents you with step 1.3 which will read the PSI-supplied property file. Choose "Perform" from the Actions dropdown menu.

![deploy_qwt_45](/images/deploy_qwt_45.jpg)

Review the JCL of Step 1.3, which shows the PSI-supplied properties file ( QWT.CPAC.PROPVAR ) being read from the SYSUT1 DD card. Press "Next" and then press "Finish" to execute the step.

![deploy_qwt_46](/images/deploy_qwt_46.jpg)

Step 2 is optional, to define RACF profiles. Follow your site standards for this. In the case of a functional installation of a ZPDT system I chose "Override complete" from the Actions dropdown menu.

![deploy_qwt_47](/images/deploy_qwt_47.jpg)

Step 3 is to update the Subsystem PARMLIB. Choose "Perform" from the Actions dropdown menu.
 

![deploy_qwt_48](/images/deploy_qwt_48.jpg)

Review the JCL. If it was necessary to update Subsystem PARMLIB for controlled operations (such as APF authorisation or LINKLIST), those updates would be made here. In our case, the JCL comments point of that this order does not include any datasets that need to APF-authorised or added to LINKLIST. Press Next and Finish.


![deploy_qwt_49](/images/deploy_qwt_49.jpg)

Step 4 is to mount any ZFS filesystems. Choose "Perform" from the Actions dropdown menu.

![deploy_qwt_50](/images/deploy_qwt_50.jpg)

Review the JCL. It creates a new member (BPXPRMDB) in PARMLIB that contains the ZFS mounting details.

![deploy_qwt_51](/images/deploy_qwt_51.jpg)

I don't want to add a new member to my PARMLIB, because I perfer to enter all the ZFS filesystem mounts for the products I have installed in a single PARMLIB member.

So I edit USER.Z31C.PARMLIB(BPXPRMZZ) which is my PARMLIB member for ZFS mounts, and I enter the same information (plus comments) in lines 1 thru 24 of this member. If I wanted to mount these datasets dynamically, I could enter the appropriate USS mount commands from USS, but I know I will perform an IPL before the customisation of QWT, so I will wait for these datasets to be mounted automatically after the planned IPL, which will test the validity of my BPXPRMZZ definitions.

![bpxprmzz](/images/bpxprmzz.jpg)

So, for Step 4, choose "Override Complete" from the Actions dropdown menu.

And the choose "Perform" from the Actions dropdown menu to Update the SMPE DDEFs.

![deploy_qwt_53](/images/deploy_qwt_53.jpg)

Check that step 5 completes successfully, and then perform Step 6 ( Relink load modules with CALLLIBs ). Relinking load modules with CALLLIBs ensures that all external references in executable modules are properly resolved using the correct versions of libraries, especially after updates or maintenance.

![deploy_qwt_54](/images/deploy_qwt_54.jpg)

Now Perform Step 7. (no action here).

![deploy_qwt_55](/images/deploy_qwt_55.jpg)

Now Perform Step 8. (Saving a properties file for use in future installation or maintenance work).

![deploy_qwt_56](/images/deploy_qwt_56.jpg)

Now Perform Step 9. (no action here).

![deploy_qwt_57](/images/deploy_qwt_57.jpg)

Looking Good : All workflows complete. Press Close.

![deploy_qwt_58](/images/deploy_qwt_58.jpg)

Back to the Deployment Checklist. Click on "Specify Properties of the target instance".

![deploy_qwt_59](/images/deploy_qwt_59.jpg)

Review the name and comments. Press OK.

![deploy_qwt_60](/images/deploy_qwt_60.jpg)

See that the QWT PSI deployment is now Completed.

![deploy_qwt_61](/images/deploy_qwt_61.jpg)

That's all folks. QWT PSI is deployed. Next Step is Customisation.

[home](https://github.com/zeditor01/zowe_db2_tools/blob/main/docs/ZPDT_Build_Path.md)
