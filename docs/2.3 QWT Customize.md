[home](https://github.com/zeditor01/zowe_db2_tools/blob/main/docs/ZPDT_Build_Path.md)

# QWT Customisation

The process of customising a product after it is installed varies from product to product.

* Traditionally for a 3270-based Db2 tool, it would typically mean editing the site's ISPF menus to provide a link to the ISPF menus of the new product, and providing connection and authorisation details to attach to Db2 z/OS subsytems.
* QWT is more modern. It does not have any 3270 panels. It runs inside a Liberty server, and is accessed by RESTful API calls from VSCODE or Zowe. So the customisation steps for QWT involve setting up a Liberty server, and configuring TCPIP connections and RACF certificates to make those connections secure.

## Reference Documentation

This GitHub page is just a worked example, with screenshots and a sequential narrative that is hopefully easy to follow. You should familiarise yourself with the product documentation. The links below are what you need.

[Planning for QWT Installation](https://www.ibm.com/docs/en/db2-for-zos/13.0.0?topic=services-preparing-install)

[Installing QWT](https://www.ibm.com/docs/en/db2-for-zos/13.0.0?topic=services-installing)

[Setting up a User Environment](https://www.ibm.com/docs/en/db2-for-zos/13.0.0?topic=services-setting-up-user-environment)

## QWT Architecture

The links above include a good architecture diagram, shown below. 
* The central engine of QWT is the Tuning Services Server, which is a Liberty server running in USS.
* It's metadata is stored in a Repository Database, which resides in a Db2 z/OS subsystem.
* It can be used to tune SQL in any connectable Db2 z/OS subsystem (including the Repository Database).
* It supports Tuning request via RESTful API calls from Zowe and VSCODE.

![qwtarch](/images/qwtarch.jpg)


## Required QWT IDs.

Setting UP QWT requires multiple RACF userids for different tasks, as described [here](https://www.ibm.com/docs/en/db2-for-zos/13.0.0?topic=install-required-user-ids-permissions)

In summary, 4 userids are needed, as follows

* tms_setup_userid - is needed to perform systems programming tasks, like running the customisation jobs, and creating the Libery Server.
* tms_userid - is needed to act as the started task userid for the Liberty Server that hosts the SQL Tuning Services
* db2_authid_repository_db - is the userid that Tuning Services uses to read and write from the Repository Database
* db2_authid_target_db - is the userid that Tuning Services uses to read and write to to Terget Database(s)

I decided to use my regular userid for the systems programming task, and create 3 new RACF userids for the additional roles.
* tms_setup_userid = IBMUSER
* tms_userid = TMSUSER
* db2_authid_repository_db = TMSREPO
* db2_authid_target_db = TMSDBDG

I created a job to define the three new userids IBMUSER.AACNTL(QWTJ01). I also created an extra userid (TMSTEST) in case of the need for additional testing. The job below is adapted from the library of standard jobs ( ADCD.LIB.JCL ) that is provided with the ADCD distribution for common tasks. This job creates a group (QWT) and 4 userids (each with TSO segment, non-expirey password, and in group QWT).

![qwtj01](/images/qwtj01.jpg)

After submitting the job and checking for succesful execution, the userids are good to be used for the QWT purposes. However, if you wanted to logon to TSO and ISPF you would need to allocate an ISPF profile dataset for each of them. Just use the attibutes of IBMUSER.S0W1.ISPF.ISPPROF to allocate datasets for TMSUSER and other userids: TMSUSER.S0W1.ISPF.ISPPROF


## QWT Datasets

Lets also review the datasets that were laid down by the PSI deployment. The image below includes annotations that summaries the purpose of them.

![qwtdatasets](/images/qwtdatasets.jpg)

We will be working with the following datasets


* QWT.DSN.SDSN5TDB which contains the database Bind Files
* QWT.DSN.SDSN5TSA which contains the customisation jobs

## Editing the Db2 Permissions Job

Job QWT.DSN.SDSN5TSA(DSN5RTRP) contains the JCL to grant permissions for SQL processing by Tuning Services. We will use this job to provide a detailed example of how to customise the job to our requirement. You can edit the job in situ. I tend to take a copy of the job, and edit the copy, so that I can always refer back to the original.

The image below is a copy of QWT.DSN.SDSN5TSA(DSN5RTRP) , which is named QWT.DSN.SDSN5TSA(AAA5RTRP). Lines 24 to 36 provide instructions on how to customize the job to meet the site-specific requirements. I have started with line 27, to change all occurances of !DSN! to the subsystem name of my Db2 Subsystem (DBDG). I enter the change command ```c !DSN! DBDG all``` in the command prompt at the top of the screen and press enter.


![cust_qwt_01](/images/cust_qwt_01.jpg)

I then perform all the other edits from (A) to (E), 

```
c !DSN! DBDG all
c DSN!!0 DSND10 all
c DSNTIA!! DSNTIA13 all
c !AUTH_ID! TMSREPO all
c !SQLID! IBMUSER all
```

and all the changed lines are highlighted.


![cust_qwt_02](/images/cust_qwt_02.jpg)

Next, I comment out the SDSNEXIT DD card in JOBLIB, because my site does not have and Db2 z/OS exit libraries.

![cust_qwt_03](/images/cust_qwt_03.jpg)

Now, I exit the SYSTSIN DD card, to specify the correct values of programs, plans and libraries for my system.


![cust_qwt_05](/images/cust_qwt_05.jpg)

Now, I add a valid JOB Card.

![cust_qwt_06](/images/cust_qwt_06.jpg)

And I Submit the job, by typing "sub" at the command line and pressing enter. I also not the Job Number (JOB00360) to help me find the output in SDSF.

![cust_qwt_07](/images/cust_qwt_07.jpg)

These detailed notes on how to edit a JCL job for customization processes will not be repeated in this GitHub repository for other jobs that need to be customised. However, I wanted to provide a detailed example of one job at the start.

Actually, Job DSN5RTRP will not complete successfully at this point, because the packages have not yet been bound. We will return to re-run this job later on, after we have run the job to bind the packages.

## Create the Repository Database

Edit and Run Job DSN5REPO to create the SQL Tuning Services Repository Database.

Following the same editing approach as before. I copied DSN5REPO into member AAA5REPO for editing. 

![cust_qwt_08](/images/cust_qwt_08.jpg)

I made the following edits

```
c !DSN! DBDG all
c DSN!!0 DSND10 all
c DSNTIA!! DSNTIA13 all
c !SQLID! IBMUSER all
c BP4KTS! BP0 all
c BP8KTS! BP8K0 all
c BP16KTS! BP16K0 all
c TSSG! SYSDEFLT all
c BP4KIX! BP0 all

c DSND10.RUNLIB.LOAD DSND10.DBDG.RUNLIB.LOAD all

Add a Job card

Edit Joblib to remove SDSNEXIT

```


And these are the outputs from the Job, viewed in SDSF.

![cust_qwt_09](/images/cust_qwt_09.jpg)

The JESMSGLG shows that all steps completed successfully with Return Code Zero. Please review all the other SDSF outputs to check for successful completions.

![cust_qwt_10](/images/cust_qwt_10.jpg)


## Bind the QWT Packages

Edit and Run Job DSN5BND to bind the SQT packages to the Repository Database. Job DSN5BND is designed for the scenario where the same Db2 z/OS subsystem is use as the target database as well as the Repository Database. Jobs are provided for binding the a subset of packages to Subsystems that are target-only or repository-only.

I made the following changes

```
c !DSN! DBDG all
c DSN!!0 DSND10 all
c !TMSDBRM! QWT.DSN.SDSN5TDB all
c !PKGOWNER! TMSREPO all
c !COMPAT! V13R1M506 all
```

![dsn5nbnd](/images/dsn5nbnd.jpg)


The job ran with Return Code 4, which is not a problem because these packages are IBM-Supplied.

```
RC04
DSNE932I WARNING, ONLY IBM-SUPPLIED PACKAGE-IDS SHOULD BEGIN WITH  "DSN" 
```


## Grant EXECUTE privileges

This is the right time to execute the job that we edited at the start of this page. Customize and run the DSN5RTRP sample job to grant the sqlts_repodb_id EXECUTE privileges to the packages


## Create the UDFs

Next, I copied DSN5RUDF into member AAA5RUDF for editing. This job defines the UDFs ( User Defined Functions ) in Db2 z/OS that will be used to control who can view and administer Query Tuning jobs.  I perform the following edits

```
c !DSN! DBDG all
c DSN!!0 DSND10 all
c DSNTIA!! DSNTIA13 all
c !AUTH_ID!  TMSUSER  all

c DSND10.RUNLIB.LOAD DSND10.DBDG.RUNLIB.LOAD all
```



![cust_qwt_11](/images/cust_qwt_11.jpg)


Once edited, I submit the job and check for successful execution.


## Tuning Priviledges



Next, I copied DSN5RTTG into member AAA5RTTG for editing. This job  grant package privileges, privileges to run several specific tuning APIs, and the privilege to create EXPLAIN tables to the intended tuning IDs. I perform the following eidts


```
c !DSN! DBDG all
c DSN!!0 DSND10 all
c DSNTIA!! DSNTIA13 all
c !AUTH_ID!  TMSUSER  all
c !SQLID!  IBMUSER  all

c DSND10.RUNLIB.LOAD DSND10.DBDG.RUNLIB.LOAD all
```

![cust_qwt_12](/images/cust_qwt_12.jpg)

Once edited, I submit the job and check for successful execution.


## Prepare the Started Task

Next Up, is to prepare the Started Task.

A template for the started task JOB is provided in QWT.DSN.SDSN5TSA(DSN5STRT), shown below.


![cust_qwt_13](/images/cust_qwt_13.jpg)

Copy it to USER.Z31C.PROCLIB(DSN5STRT) and edit it as follows.

* Line 1 : the name of the Liberty Server will be TMS1
* The installation directory of Liberty binaries on this system is /usr/lpp/liberty_zos/current 
* The user directory where liberty servers are stored on this system is /global/liberty

![cust_qwt_14](/images/cust_qwt_14.jpg)

Started Tasks must be defined to RACF. The RACF commands to define the DSN5STRT task, and refresh the RACF cache are show in job IBMUSER.AACNTL(RACFQWT1), shown below.

![cust_qwt_15](/images/cust_qwt_15.jpg)

After defining the started task to RACF, you can check the active definition with the RACF command "RLIST STARTED DSN5STRT.** STDATA"

![cust_qwt_16](/images/cust_qwt_16.jpg)


## Prepare the RACF Keyring and Certificates

The purpose of the Keyring and certificates is to enable secure ( i.e. encrypted ) TCPIP connections from Zowe and VSCODE to QWT.

Aside from being good practice to encrypt all traffic, this is actually required for the connection from the Db2 for z/OS Developer Extension for VSCODE to actually work. It is designed not to accept insecure connection requests.

At the time of writing ( August 2025 ) the example certificate definition in the [Db2 Knowledgecenter](https://www.ibm.com/docs/en/db2-for-zos/13.0.0?topic=installing-setting-up-started-task-id-creating-key-ring-it) does not work!

![kc_cert_example](/images/kc_cert_example.jpg)

Modern browsers require the Subject Alternative Name (SAN) extension, specified as ALTNAME(DOMAIN('hostname')) in certificate creation, for the certificate to be trusted, particularly for HTTPS connections to work without errors. 

I needed to add ALTNAME(DOMAIN('S0W1.DAL-EBIS.IHOST.COM')) to the server certificate, in order for it to support a secure connection.

Actually, the example in the knowledge center would support the calling of the APIs from Zowe and VSCODE, but it would not support the user setup steps (such as defining profiles) that are recommended to be invoked from a browser rather than a CURL command.


The job below is what I used to define a server certificate, signed by the existing CA certificate that my z/OS system uses (BaseCA), and defining my z/OS hostname (s0w1.dal-ebis.ihost.com) on both the SUBJECTSDN and the ALTNAME. 

![certjob](/images/certjob.jpg)

It is a good idea to check the Keyring and it's contents. The command ```racdcert id(TMSUSER) listring(QWTKeyring)``` will list the certifcates connected to the Keyring QWTKeyring. The command output shows that the server certificate is indeed the default certificate in the keyring, and it's CA Cert is also connected to the keyring.


![certcheck](/images/certcheck.jpg)


## Reserving a Port.

The default port for QWT is 9444. Unfortunately that port conflicts with some z/OSMF services on my ADCD image. So I decided to reserve port 15001 for QWT. To do this, I edited my TCPIP profile in USER.Z31C.TCPPARMS(PROF2) as follows.

![cust_qwt_23](/images/cust_qwt_23.jpg)

## Configuring the Liberty Server to run QWT

During deployment we mounted the ZFS filesystems at the designated mount points in USS. Now we need to edit a configuration file for the TMS Service, and run the Installation Script.

Open an ssh shell and navigate to /usr/lpp/IBM/db2tms/v2r1/tmsinstall

copy tmsservice.config to tmeservice.configoriginal if you want to save an unedited copy of the original template

From TSO option 2, edit /usr/lpp/IBM/db2tms/v2r1/tmsinstall/tmsservice.config

![edittms](/images/edittms.jpg)


Starting on line 14, the SQL Tuning Services section defines the connection and configuration definitions for the QWT Server. 

I have set ```host_name=S0W1.DAL-EBIS.IHOST.COM ``` and ```httpsport=15001``` as per my previous notes.

everything else in this section is default


Starting on line 57 is the Liberty Server configuration.


```liberty_path=/usr/lpp/liberty_zos/current``` is left to default                    
                                                                                                                               
```wlp_user_dir=/global/liberty``` is where I want to new Libery Server to be placed                                      
                                                                                                                        
```server_name=TMS1``` is the name I want it to have                                                          
                                                     

![cust_qwt_25](/images/cust_qwt_25.jpg)

Continuing to line 73, for the Repository Database Configuration, I have defined the values I used earlier


```host=S0W1.DAL-EBIS.IHOST.COM```                 
                                                               
```port=5045```                                                      
                                                               
```locationName=DALLASD```                                           
                                                               
```user=TMSREPO```


![cust_qwt_26](/images/cust_qwt_26.jpg)


Returning to my ssh shell, open at path /usr/lpp/IBM/db2tms/v2r1/tmsinstall

![cust_qwt_27](/images/cust_qwt_27.jpg)

I need to execute the tmsinstall.sh script and supply that script with the name of my newly edited config file, using the following command

```./tmsinstall.sh /usr/lpp/IBM/db2tms/v2r1/tmsservice.config```


During execution of the script, I am prompted for the password for user TMSREPO ( which is TMSPASS ). The screenshot below captures the dialog which generated the TMS1 Libery Server at /globa/liberty/servers/TMS1

![cust_qwt_28](/images/cust_qwt_28.jpg)



It's instructive to take a look at the USS path where the QWT Libery Server is deployed. From USS, navigate to /global/liberty/servers/TMS1 and list the contents. In particular, cat the contents of server.xml which defines the Liberty server configuration, including the secure port that it is listening on and the SSL connection parameters that have been defined.

![usspath](/images/usspath.jpg)


That's all folks ! The QWT server is ready to start up. We can progress to the Installation verification steps.


[home](https://github.com/zeditor01/zowe_db2_tools/blob/main/docs/ZPDT_Build_Path.md)


